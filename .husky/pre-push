#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸš€ PRE-PUSH HOOK: Verifying code before deployment${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Get the current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "${YELLOW}ğŸ“Œ Branch: ${BRANCH}${NC}"
echo ""

# 1. Check for TypeScript errors (fastest check)
echo "${YELLOW}1/3 TypeScript Check...${NC}"
npm run typecheck --silent
if [ $? -ne 0 ]; then
    echo ""
    echo "${RED}âŒ TypeScript errors detected!${NC}"
    echo "${YELLOW}ğŸ’¡ Run 'npm run typecheck' to see details${NC}"
    echo "${YELLOW}ğŸ’¡ Fix TypeScript errors before pushing to prevent Vercel build failures${NC}"
    exit 1
fi
echo "${GREEN}   âœ“ TypeScript check passed${NC}"
echo ""

# 2. Run ESLint (medium speed)
echo "${YELLOW}2/3 ESLint Check...${NC}"
npm run lint --silent
if [ $? -ne 0 ]; then
    echo ""
    echo "${RED}âŒ ESLint errors detected!${NC}"
    echo "${YELLOW}ğŸ’¡ Run 'npm run lint' to see details${NC}"
    echo "${YELLOW}ğŸ’¡ Some ESLint errors will cause Vercel builds to fail${NC}"
    exit 1
fi
echo "${GREEN}   âœ“ ESLint check passed${NC}"
echo ""

# 3. Run build test (slowest but most comprehensive)
echo "${YELLOW}3/3 Build Test...${NC}"
echo "${YELLOW}   This may take a minute...${NC}"
npm run build --silent > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo ""
    echo "${RED}âŒ Build failed!${NC}"
    echo "${YELLOW}ğŸ’¡ Run 'npm run build' to see detailed errors${NC}"
    echo "${YELLOW}ğŸ’¡ This would cause Vercel deployment to fail${NC}"
    echo ""
    echo "${RED}Push cancelled to prevent deployment failure.${NC}"
    exit 1
fi
echo "${GREEN}   âœ“ Build test passed${NC}"
echo ""

echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}âœ… All checks passed! Your code is ready for deployment.${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "${BLUE}Pushing to ${BRANCH}...${NC}"
echo ""