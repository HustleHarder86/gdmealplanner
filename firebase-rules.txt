// Firebase Firestore Security Rules for GD Meal Planner
// Copy these rules to Firebase Console > Firestore > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Glucose Readings Collection
    match /glucoseReadings/{document} {
      // Users can read their own glucose readings
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
      
      // Users can create glucose readings for themselves
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid) &&
        (request.resource.data.value is number) &&
        (request.resource.data.timestamp is timestamp);
      
      // Users can update their own glucose readings
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid) &&
        (request.resource.data.userId == request.auth.uid);
      
      // Users can delete their own glucose readings
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
    }
    
    // User Recipes Collection
    match /user_recipes/{document} {
      // Users can read public recipes or their own private recipes
      allow read: if isAuthenticated() && 
        (resource.data.isPrivate == false || 
         resource.data.userId == request.auth.uid);
      
      // Users can create recipes for themselves
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid);
      
      // Users can update their own recipes
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
      
      // Users can delete their own recipes
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
    }
    
    // Recipes Collection (System recipes - read only)
    match /recipes/{document} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin SDK can write
    }
    
    // User Profiles Collection
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }
    
    // Meal Plans Collection
    match /mealPlans/{document} {
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
        (request.resource.data.userId == request.auth.uid);
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
      allow delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid);
    }
  }
}

// IMPORTANT: After updating these rules in Firebase Console:
// 1. Click "Publish" to apply the changes
// 2. Test the rules using the Firebase Console Rules Playground
// 3. Monitor the Firebase Console for any security warnings